<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outage History - Power Outage Statistics Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Additional styles for the custom filter dropdown */
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .controls-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .controls-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .filter-dropdown-container {
            display: inline-block;
            position: relative;
        }
        
        .filter-dropdown-btn {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 150px;
            color: #333;
        }
        
        .filter-dropdown-btn::after {
            content: "â–¼";
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
        
        .filter-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            overflow: hidden;
            left: 0;
        }
        
        .filter-dropdown-content.show {
            display: block;
        }
        
        .filter-dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .filter-dropdown-item:hover {
            background-color: #e9ecef;
        }
        
        .filter-dropdown-item.active {
            background-color: #e6f7ff;
            color: #1890ff;
        }
        
        .results-count {
            font-weight: bold;
            color: white;
        }
        
        .export-btn {
            background-color: #1e7e34;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .export-btn:hover {
            background-color: #155724;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin: 0;
            color: #333;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            margin-bottom: 1.5rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .filter-group {
            margin-bottom: 1rem;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
            color: #333;
        }
        
        .filter-input, .filter-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            color: #333;
            background-color: white;
        }
        
        .apply-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        
        .apply-btn:hover {
            background-color: #0069d9;
        }
        
        .clear-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        
        .clear-btn:hover {
            background-color: #5a6268;
        }
        
        .quick-filters {
            margin-bottom: 1rem;
        }
        
        /* Loading and error states */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data, .error-state {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .error-state {
            color: #d9534f;
        }
        
        /* Table styles - Auto-fit height */
        .table-container {
            overflow-x: auto;
            height: calc(100vh - 200px); /* Auto-fit to viewport height minus header */
            min-height: 400px; /* Minimum height */
            max-height: 80vh; /* Maximum height */
            display: flex;
            flex-direction: column;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            flex: 1; /* Fill available space */
        }

        .history-table th {
           background: var(--light-green);
           color: var(--primary-green);
            padding: 0.8rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--accent-green);
            position: sticky;
            top: 0;
        }

        .history-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #ddd;
            vertical-align: top;
        }

        .history-table tr:hover {
           background: var(--light-green);
        }

        .history-table tr:last-child td {
            border-bottom: none;
        }

        /* Status column styles */
        .status-resolved {
            color: #28a745;
            font-weight: bold;
        }

        .status-unresolved {
            color: #dc3545;
            font-weight: bold;
        }
   
        /* Loading State Improvements */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: #2c3e50;
        }

        .loading p {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        /* No Data State */
        .no-data {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-style: italic;
        }

        /* Error State */
        .error-state {
            text-align: center;
            padding: 2rem;
            color: #f44336;
            background: #ffebee;
            border-radius: 6px;
            border: 1px solid #f44336;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .table-container {
                height: calc(100vh - 180px); /* Adjust for smaller screens */
            }
            
            .history-filters {
                grid-template-columns: 1fr;
                gap: 0.8rem;
                padding: 1rem;
            }
            
            .filter-actions {
                grid-column: 1;
                justify-content: stretch;
            }
            
            .apply-btn, .clear-btn {
                flex: 1;
            }
            
            .quick-filters {
                flex-wrap: wrap;
            }
            
            .history-table {
                font-size: 0.7rem;
            }
            
            .history-table th,
            .history-table td {
                padding: 0.6rem;
            }
            
            .date-range-group {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .table-container {
                height: calc(100vh - 160px); /* Further adjust for mobile */
            }
            
            .quick-filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .quick-filter-btn {
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <!-- Top Header -->
        <div class="top-header">
            <div class="top-header-content">
                <div class="logo-container">
                    <img src="logo.png" alt="Power Outage Info Logo" class="logo">
                    <h3>BPC-POI</h3>
                </div>
                <div class="top-nav-right">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="history.html" class="nav-link active">Outage History</a>
                    <a href="reports.html" class="nav-link">Reports</a>
                    <a href="notifications.html" class="nav-link">Notifications</a>
                    <a href="others.html" class="nav-link">Others</a>
                </div>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="mobile-nav" id="mobileNav">
                <a href="index.html" class="nav-link">Home</a>
                <a href="history.html" class="nav-link active">Outage History</a>
                <a href="reports.html" class="nav-link">Reports</a>
                <a href="notifications.html" class="nav-link">Notifications</a>
                <a href="others.html" class="nav-link">Others</a>
            </div>
        </div>

        <!-- Main Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-main">
                    <div class="header-controls">
                        <div class="controls-left">
                            <!-- Filter Dropdown -->
                            <div class="filter-dropdown-container">
                                <button class="filter-dropdown-btn" id="filterDropdownBtn">Last 7 Days</button>
                                <div class="filter-dropdown-content" id="filterDropdownContent">
                                    <div class="filter-dropdown-item" data-value="0">Today</div>
                                    <div class="filter-dropdown-item active" data-value="7">Last 7 Days</div>
                                    <div class="filter-dropdown-item" data-value="30">Last 30 Days</div>
                                    <div class="filter-dropdown-item" data-value="90">Last 90 Days</div>
                                    <div class="filter-dropdown-item" data-value="custom">Custom Filter</div>
                                </div>
                            </div>
                        </div>
                        <div class="controls-right">
                            <div class="results-count">
                             Loaded   <span id="resultsCount">0</span> Records
                            </div>
                            <button class="export-btn" onclick="exportToCSV()">Export to CSV</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Outage History Content -->
        <section class="section">
            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Tripping ID</th>
                            <th>Date</th>
                            <th>Dzongkhag</th>
                            <th>Substation</th>
                            <th>Feeder</th>
                            <th>Trip Time</th>
                            <th>Restore Time</th>
                            <th>Duration</th>
                            <th>Status</th>
                            <th>Outage Area</th>
                            <th>Outage Type</th>
                            <th>Main Cause</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="outageHistoryTable">
                        <tr>
                            <td colspan="13">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p>Loading outage history...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Custom Filter Modal -->
    <div class="modal" id="customFilterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Custom Filter</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="filter-group">
                    <label for="startDateFilter">Start Date</label>
                    <input type="date" id="startDateFilter" class="filter-input">
                </div>
                <div class="filter-group">
                    <label for="endDateFilter">End Date</label>
                    <input type="date" id="endDateFilter" class="filter-input">
                </div>
                <div class="filter-group">
                    <label for="dzongkhagFilter">Dzongkhag</label>
                    <select id="dzongkhagFilter" class="filter-select">
                        <option value="all">All Dzongkhags</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="typeFilter">Outage Type</label>
                    <select id="typeFilter" class="filter-select">
                        <option value="all">All Types</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button id="applyFilters" class="apply-btn">Apply Filters</button>
                <button id="clearFilters" class="clear-btn">Clear</button>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = 'https://script.google.com/macros/s/AKfycbx_1mQmEAJeFLgH9DC_HC94jtfGWkOWvHsy5PgllItt0ZeBrx7lGMJgfaW4VskgKVHJ/exec';

        // Store current data for export
        let currentOutageData = [];

        // Mobile menu functionality
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileNav = document.getElementById('mobileNav');

        mobileMenuBtn.addEventListener('click', function () {
            this.classList.toggle('active');
            mobileNav.classList.toggle('active');
        });

        document.addEventListener('click', function (event) {
            if (!event.target.closest('.top-header-content') && !event.target.closest('.mobile-nav')) {
                mobileMenuBtn.classList.remove('active');
                mobileNav.classList.remove('active');
            }
        });

        // Filter Dropdown Functionality
        const filterDropdownBtn = document.getElementById('filterDropdownBtn');
        const filterDropdownContent = document.getElementById('filterDropdownContent');
        const filterDropdownItems = document.querySelectorAll('.filter-dropdown-item');
        const customFilterModal = document.getElementById('customFilterModal');
        const closeModal = document.getElementById('closeModal');
        let currentFilter = '7'; // Default to Last 7 Days

        // Toggle dropdown
        filterDropdownBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            filterDropdownContent.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            filterDropdownContent.classList.remove('show');
        });

        // Handle filter selection
        filterDropdownItems.forEach(item => {
            item.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                
                // Update active state
                filterDropdownItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                // Update button text
                filterDropdownBtn.textContent = this.textContent;
                
                // Close dropdown
                filterDropdownContent.classList.remove('show');
                
                // Handle custom filter
                if (value === 'custom') {
                    customFilterModal.classList.add('show');
                    currentFilter = 'custom';
                } else {
                    currentFilter = value;
                    setDateRange(parseInt(value));
                }
            });
        });

        // Modal functionality
        closeModal.addEventListener('click', function() {
            customFilterModal.classList.remove('show');
        });

        // Close modal when clicking outside
        customFilterModal.addEventListener('click', function(e) {
            if (e.target === customFilterModal) {
                customFilterModal.classList.remove('show');
            }
        });

        // Fixed date formatting functions
        function formatDate(dateValue) {
            if (!dateValue || dateValue === '-' || dateValue === null) return '-';

            try {
                // Handle both string and date objects
                const dateString = String(dateValue);
                if (dateString.trim() === '' || dateString === 'undefined') return '-';

                const date = new Date(dateString);
                return isNaN(date.getTime()) ? dateString : date.toLocaleDateString();
            } catch (e) {
                return String(dateValue);
            }
        }

        function formatTime(timeValue) {
            if (!timeValue || timeValue === '-' || timeValue === null) return '-';

            try {
                const timeString = String(timeValue);
                if (timeString.trim() === '' || timeString === 'undefined') return '-';

                if (timeString.includes('T')) {
                    const date = new Date(timeString);
                    if (isNaN(date.getTime())) return timeString;
                    
                    // Format to local time without T and Z
                    return date.toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false 
                    });
                }
                return timeString;
            } catch (e) {
                return String(timeValue);
            }
        }

        // Get status based on restore time
        function getStatus(restoreTime) {
            if (!restoreTime || restoreTime === '-' || restoreTime === null) {
                return '<span class="status-unresolved">Unresolved</span>';
            }
            return '<span class="status-resolved">Resolved</span>';
        }

        // Load outage history data
        async function loadOutageHistory(filters = {}) {
            const tableBody = document.getElementById('outageHistoryTable');
            const resultsCount = document.getElementById('resultsCount');

            tableBody.innerHTML = `
                <tr>
                    <td colspan="13">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading outage history...</p>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const params = new URLSearchParams();
                
                // Always apply date filters to prevent loading all data
                if (filters.startDate) {
                    params.append('startDate', filters.startDate);
                } else {
                    // Set default to last 7 days if no start date provided
                    const defaultStartDate = new Date();
                    defaultStartDate.setDate(defaultStartDate.getDate() - 7);
                    params.append('startDate', defaultStartDate.toISOString().split('T')[0]);
                }
                
                if (filters.endDate) {
                    params.append('endDate', filters.endDate);
                } else {
                    // Set default to today if no end date provided
                    const defaultEndDate = new Date();
                    params.append('endDate', defaultEndDate.toISOString().split('T')[0]);
                }
                
                if (filters.dzongkhag && filters.dzongkhag !== 'all') params.append('dzongkhag', filters.dzongkhag);
                if (filters.outageType && filters.outageType !== 'all') params.append('outageType', filters.outageType);

                const response = await fetch(`${API_URL}?${params}`);
                const data = await response.json();

                if (data.success && data.outages) {
                    // Store data for export
                    currentOutageData = data.outages;
                    
                    resultsCount.textContent = data.outages.length;

                    if (data.outages.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="13">
                                    <div class="no-data">
                                        No outages found for the selected filters.
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        tableBody.innerHTML = data.outages.map(outage => `
                            <tr>
                                <td>${outage.Tripping_ID || '-'}</td>
                                <td>${formatDate(outage.Date)}</td>
                                <td>${outage.Dzongkhag || '-'}</td>
                                <td>${outage.Substation || '-'}</td>
                                <td>${outage.Feeder || '-'}</td>
                                <td>${formatTime(outage['Trip Time'])}</td>
                                <td>${formatTime(outage['Restor Time'])}</td>
                                <td>${outage.Duration || '-'}</td>
                                <td>${getStatus(outage['Restor Time'])}</td>
                                <td>${outage['Outage Area'] || '-'}</td>
                                <td>${outage['Outage Type'] || '-'}</td>
                                <td>${outage['Main Cause'] || '-'}</td>
                                <td>${outage['Remarks'] || '-'}</td>
                            </tr>
                        `).join('');
                    }
                } else {
                    throw new Error(data.error || 'Failed to load data');
                }
            } catch (error) {
                console.error('Error loading outage history:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="13">
                            <div class="error-state">
                                Error loading data: ${error.message}
                            </div>
                        </td>
                    </tr>
                `;
                resultsCount.textContent = '0';
                currentOutageData = [];
            }
        }

        // Load filter options
        async function loadFilterOptions() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                if (data.success && data.outages) {
                    const dzongkhags = [...new Set(data.outages.map(o => o.Dzongkhag).filter(Boolean))].sort();
                    const outageTypes = [...new Set(data.outages.map(o => o['Outage Type']).filter(Boolean))].sort();

                    const dzongkhagSelect = document.getElementById('dzongkhagFilter');
                    const typeSelect = document.getElementById('typeFilter');

                    dzongkhags.forEach(dzongkhag => {
                        const option = document.createElement('option');
                        option.value = dzongkhag;
                        option.textContent = dzongkhag;
                        dzongkhagSelect.appendChild(option);
                    });

                    outageTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        typeSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }

        // Event listeners for custom filters
        document.getElementById('applyFilters').addEventListener('click', applyFilters);
        document.getElementById('clearFilters').addEventListener('click', clearFilters);

        function applyFilters() {
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;

            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                alert('Start date cannot be after end date');
                return;
            }

            const filters = {
                startDate: startDate,
                endDate: endDate,
                dzongkhag: document.getElementById('dzongkhagFilter').value,
                outageType: document.getElementById('typeFilter').value
            };

            loadOutageHistory(filters);
            customFilterModal.classList.remove('show');
        }

        function clearFilters() {
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            document.getElementById('dzongkhagFilter').value = 'all';
            document.getElementById('typeFilter').value = 'all';
        }

        // Quick date filters
        function setDateRange(days) {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);

            document.getElementById('startDateFilter').valueAsDate = startDate;
            document.getElementById('endDateFilter').valueAsDate = endDate;

            loadOutageHistory({
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            });
        }

        // Export to CSV function
        function exportToCSV() {
            if (currentOutageData.length === 0) {
                alert('No data available to export');
                return;
            }

            try {
                // Define CSV headers
                const headers = [
                    'Tripping ID',
                    'Date',
                    'Dzongkhag',
                    'Substation',
                    'Feeder',
                    'Trip Time',
                    'Restor Time',
                    'Duration',
                    'Status',
                    'Outage Area',
                    'Outage Type',
                    'Main Cause',
                    'Remarks'
                ];

                // Convert data to CSV format
                const csvContent = [
                    headers.join(','),
                    ...currentOutageData.map(outage => [
                        outage.Tripping_ID || '',
                        outage.Date ? new Date(outage.Date).toLocaleDateString() : '',
                        outage.Dzongkhag || '',
                        outage.Substation || '',
                        outage.Feeder || '',
                        outage['Trip Time'] || '',
                        outage['Restor Time'] || '',
                        outage.Duration || '',
                        // Status for CSV (text only, no HTML)
                        outage['Restor Time'] && outage['Restor Time'] !== '-' && outage['Restor Time'] !== null ? 'Resolved' : 'Unresolved',
                        outage['Outage Area'] || '',
                        outage['Outage Type'] || '',
                        outage['Main Cause'] || '',
                        outage['Remarks'] || ''
                    ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
                ].join('\n');

                // Create and download CSV file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `outage_history_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up URL object
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting data to CSV. Please try again.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            loadFilterOptions();
            
            // Set default to last 7 days and load data
            setDateRange(7);
        });
    </script>
</body>

</html>